{{!-- Custom styles specific to index content --}}
<style>
    #equityChart {
        width: 100% !important;
        height: 100% !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{!-- Auto-reload script --}}
<script>
    setTimeout(() => window.location.reload(), 30000); // 30s auto-refresh
</script>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Available (Cash)</div>
        <div class="stat-value">{{stats.currentBalance}} USDC</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Invested</div>
        <div class="stat-value" style="color: #cbd5e1">{{stats.invested}} USDC</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Equity</div>
        <div class="stat-value" style="color: #fbbf24">{{stats.equity}} USDC</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Profit/Loss (PnL)</div>
        <div class="stat-value {{#if stats.isPositive}}price-pos{{else}}price-neg{{/if}}">{{stats.pnl}}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Activity (Open / Closed)</div>
        <div class="stat-value" style="color: #60a5fa">{{stats.openTrades}} / {{stats.closedTrades}}</div>
    </div>
</div>

<div class="card">
    <div class="card-header">Equity Curve</div>
    <div style="height: 300px; padding: 1rem;">
        <canvas id="equityChart"></canvas>
    </div>
</div>

<div class="card">
    <div class="card-header">
        Recent Trades
        <button class="refresh-btn" onclick="window.location.reload()">Refresh</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Time</th>
                <th>Market</th>
                <th>Ends in</th>
                <th>Status</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Price</th>
                <th>Mode</th>
            </tr>
        </thead>
        <tbody>
            {{#each trades}}
            <tr>
                <td style="color: var(--text-muted); font-size: 0.8rem;">{{add @index 1}}</td>
                <td style="color: var(--text-muted)">{{this.time}}</td>
                <td style="font-weight: 600">{{this.title}}</td>
                <td style="color: var(--accent); font-weight: 600;">{{this.remaining}}</td>
                <td>
                    {{#if this.result}}
                        <span class="badge {{#if (eq this.result 'WIN')}}price-pos{{else}}price-neg{{/if}}" style="background: rgba(0,0,0,0.2)">
                            {{this.result}}
                        </span>
                    {{else}}
                        {{#if (eq this.remaining 'Closed')}}
                            <span class="badge" style="background: #ef4444; color: white;">PENDING</span>
                        {{else}}
                            <span class="badge" style="background: rgba(255,255,255,0.1)">OPEN</span>
                        {{/if}}
                    {{/if}}
                </td>
                <td>
                    <span class="{{#if this.isBuyYes}}price-pos{{else}}price-neg{{/if}}">
                        {{this.type}}
                    </span>
                </td>
                <td style="font-family: monospace; font-weight: bold;">{{this.amount}}</td>
                <td>{{this.price}}</td>
                <td>
                    <span class="badge {{#if this.simulation}}badge-sim{{else}}badge-live{{/if}}">
                        {{#if this.simulation}}SIM{{else}}LIVE{{/if}}
                    </span>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>

<script>
    async function loadChart() {
        try {
            const resp = await fetch('/api/stats');
            const data = await resp.json();
            const history = data.history;
            
            const ctx = document.getElementById('equityChart').getContext('2d');
            
            // Prepare Data
            const labels = history.map(pt => new Date(pt.x).toLocaleTimeString());
            const equityData = history.map(pt => pt.y);
            const cashData = history.map(pt => pt.cash);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Equity',
                            data: equityData,
                            borderColor: '#fbbf24',
                            backgroundColor: 'rgba(251, 191, 36, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Available (Cash)',
                            data: cashData,
                            borderColor: '#3b82f6',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        } catch (e) {
            console.error("Chart load failed:", e);
        }
    }
    loadChart();
</script>
